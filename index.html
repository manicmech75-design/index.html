<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b1220">
  <link rel="icon" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>City Flip</title>

  <style>
    :root{
      --bg1:#1a2a44; --bg2:#0b1220;
      --panel: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.12);
      --text:#fff; --muted: rgba(255,255,255,0.72);
      --accent:#4ade80; --danger:#fb7185;
      --radius:16px;
      --safeT: env(safe-area-inset-top, 0px);
      --safeB: env(safe-area-inset-bottom, 0px);
      --safeL: env(safe-area-inset-left, 0px);
      --safeR: env(safe-area-inset-right, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--text);
      background: radial-gradient(circle at top, var(--bg1), var(--bg2));
      display:flex;
      justify-content:center;
      align-items:center;
      padding: calc(16px + var(--safeT)) calc(16px + var(--safeR)) calc(16px + var(--safeB)) calc(16px + var(--safeL));
      overscroll-behavior:none;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .app{width:min(560px,100%); display:grid; gap:12px;}
    .topbar{
      display:grid;
      grid-template-columns: 1fr auto auto auto auto auto;
      gap:10px;
      align-items:center;
      padding:12px 12px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900;}
    .logo{
      width:34px; height:34px;
      display:grid; place-items:center;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.05));
      border:1px solid rgba(255,255,255,0.12);
      font-size:18px;
    }
    .sub{font-size:12px;color:rgba(255,255,255,0.70);margin-top:2px}
    .stat{ text-align:right; line-height:1.1; min-width: 62px; }
    .stat .label{font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.6px;}
    .stat .value{font-size:17px; font-weight:900;}

    .iconbtn{
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      color:#fff;
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 900;
      cursor: pointer;
      line-height: 1;
      touch-action: manipulation;
    }
    .iconbtn:active{ transform: translateY(1px); }

    .frame{
      position:relative;
      background: rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.10);
      border-radius: calc(var(--radius) + 6px);
      overflow:hidden;
      aspect-ratio: 9/16;
      box-shadow: 0 24px 80px rgba(0,0,0,0.35);
      touch-action: manipulation;
    }
    canvas{width:100%; height:100%; display:block;}

    .toast{
      position:absolute; top:12px; left:50%;
      transform:translateX(-50%);
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      background: rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.14);
      color:#fff;
      opacity:0;
      transition: opacity 160ms ease, transform 160ms ease;
      pointer-events:none;
      backdrop-filter: blur(8px);
      z-index: 3;
      white-space: nowrap;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(2px); }

    .overlay{
      position:absolute; inset:0;
      display:grid; place-items:center;
      padding:18px;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.10), rgba(0,0,0,0.45));
      z-index: 4;
    }
    .card{
      width:min(460px,92%);
      padding:16px;
      border-radius:18px;
      background: rgba(10, 18, 32, 0.82);
      border:1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(10px);
      text-align:center;
    }
    .card h1{margin:0 0 6px; font-size:22px;}
    .card p{margin:0 0 12px; color:var(--muted); font-size:14px; line-height:1.35;}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .btnrow{display:grid; gap:10px;}
    .btn{
      width:100%;
      border:0; cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900; font-size:16px;
      color:#062312;
      background: linear-gradient(180deg, #86efac, #22c55e);
    }
    .btn.secondary{
      color:#0b1220;
      background: linear-gradient(180deg, #e5e7eb, #cbd5e1);
    }
    .pill{
      display:inline-block;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.85);
      margin: 6px 4px 0 4px;
    }

    .settings{
      text-align:left;
      margin-top: 10px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
    }
    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:8px 6px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .row:last-child{border-bottom:none}
    .row label{font-size:13px;color:rgba(255,255,255,0.90)}
    select, input[type="checkbox"]{ transform: scale(1.1); }
    select{
      background: rgba(255,255,255,0.10);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 10px;
      padding: 8px 10px;
      outline: none;
    }
    input[type="range"]{ width: 160px; }

    .footer{ text-align:center; font-size:12px; color: rgba(255,255,255,0.65); }

    .hc .topbar,.hc .card{border-color: rgba(255,255,255,0.30)}
    .hc .frame{border-color: rgba(255,255,255,0.24)}
  </style>
</head>

<body>
  <div class="app" id="appRoot">
    <div class="topbar">
      <div class="brand">
        <div class="logo">üèôÔ∏è</div>
        <div>
          <div style="font-size:18px;">City Flip</div>
          <div class="sub" id="modeLabel">Mode: Easy ‚Ä¢ Classic ‚Ä¢ Level 1</div>
        </div>
      </div>

      <div class="stat">
        <div class="label">Score</div>
        <div class="value" id="score">0</div>
      </div>

      <div class="stat">
        <div class="label">Best</div>
        <div class="value" id="best">0</div>
      </div>

      <div class="stat">
        <div class="label">Streak</div>
        <div class="value" id="streak">0</div>
      </div>

      <button class="iconbtn" id="pauseBtn" title="Pause" aria-label="Pause">‚è∏</button>
      <button class="iconbtn" id="settingsBtn" title="Settings" aria-label="Settings">‚öôÔ∏è</button>
    </div>

    <div class="frame" id="frame">
      <canvas id="game"></canvas>
      <div class="toast" id="toast">Perfect!</div>

      <div class="overlay" id="overlay" aria-live="polite">
        <div class="card" id="menuCard">
          <h1>Build the skyline</h1>
          <p>Tap to drop blocks. Overhang gets cut off. Miss the stack = game over (except Zen).</p>

          <div class="grid2">
            <button class="btn secondary" id="easyBtn">Easy</button>
            <button class="btn secondary" id="hardBtn">Hard</button>
          </div>

          <div class="btnrow" style="margin-top:10px;">
            <button class="btn" id="startBtn">Start Classic</button>
            <button class="btn secondary" id="dailyBtn">Daily Challenge</button>
            <button class="btn secondary" id="zenBtn">Zen Mode</button>
            <button class="btn secondary" id="installBtn" style="display:none;">Install App</button>
          </div>

          <div style="margin-top:10px;">
            <span class="pill" id="achPill">Achievements: 0</span>
            <span class="pill" id="dailyPill">Daily: not played</span>
          </div>

          <p style="margin-top:10px;color:rgba(255,255,255,0.60);font-size:12px;">
            Ultimate upgrades: particles + perfect flash + music ducking + sliders + accessibility settings ‚úÖ
          </p>
        </div>
      </div>
    </div>

    <div class="footer">City Flip ‚Ä¢ Ultimate PWA build</div>
  </div>

  <script>
    try {
      // DOM
      const root = document.getElementById("appRoot");
      const canvas = document.getElementById("game");
      const ctx = canvas.getContext("2d");
      const overlay = document.getElementById("overlay");
      const toast = document.getElementById("toast");
      const scoreEl = document.getElementById("score");
      const bestEl = document.getElementById("best");
      const streakEl = document.getElementById("streak");
      const modeLabel = document.getElementById("modeLabel");
      const pauseBtn = document.getElementById("pauseBtn");
      const settingsBtn = document.getElementById("settingsBtn");
      const frame = document.getElementById("frame");
      const MENU_TEMPLATE = overlay.innerHTML;

      // Storage keys
      const KEYS = {
        best: "cityflip_best_ultra_v2",
        mode: "cityflip_mode_ultra_v2",
        sfxOn: "cityflip_sfx_on_ultra_v2",
        musicOn: "cityflip_music_on_ultra_v2",
        sfxVol: "cityflip_sfx_vol_ultra_v2",
        musicVol: "cityflip_music_vol_ultra_v2",
        haptics: "cityflip_haptics_ultra_v2",
        lefthand: "cityflip_lefthand_ultra_v2",
        contrast: "cityflip_contrast_ultra_v2",
        motion: "cityflip_motion_ultra_v2",
        achievements: "cityflip_ach_ultra_v2",
        daily: "cityflip_daily_ultra_v2"
      };

      // Settings
      let best = Number(localStorage.getItem(KEYS.best) || 0);
      bestEl.textContent = best;

      let mode = localStorage.getItem(KEYS.mode) || "easy";
      let sfxOn = (localStorage.getItem(KEYS.sfxOn) !== "0");        // default ON
      let musicOn = (localStorage.getItem(KEYS.musicOn) === "1");     // default OFF
      let sfxVol = Number(localStorage.getItem(KEYS.sfxVol) || 0.55); // 0..1
      let musicVol = Number(localStorage.getItem(KEYS.musicVol) || 0.25);
      let hapticsOn = (localStorage.getItem(KEYS.haptics) !== "0");   // default ON
      let leftHand = (localStorage.getItem(KEYS.lefthand) === "1");
      let hiContrast = (localStorage.getItem(KEYS.contrast) === "1");
      let reducedMotion = (localStorage.getItem(KEYS.motion) === "1");

      if (hiContrast) root.classList.add("hc");

      // Achievements
      const ACH = {
        FIRST_PERFECT: "FIRST_PERFECT",
        TEN_SCORE: "TEN_SCORE",
        FIFTY_SCORE: "FIFTY_SCORE",
        DAILY_PLAY: "DAILY_PLAY",
        HARD_25: "HARD_25"
      };
      function loadAch() {
        try { return JSON.parse(localStorage.getItem(KEYS.achievements) || "[]"); } catch { return []; }
      }
      function setAch(list) {
        localStorage.setItem(KEYS.achievements, JSON.stringify(list));
      }
      let achievements = loadAch();
      function unlock(code, label) {
        if (achievements.includes(code)) return;
        achievements.push(code);
        setAch(achievements);
        showToast(`üèÜ ${label}`);
      }

      // PWA install
      let deferredPrompt = null;
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const btn = overlay.querySelector("#installBtn");
        if (btn) btn.style.display = "block";
      });

      // iOS hint
      const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
      const isStandalone = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches;

      // SW
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => navigator.serviceWorker.register("/sw.js").catch(()=>{}));
      }

      // Modes
      const MODES = {
        easy: { name: "Easy", baseSpeed: 2.2, ramp: 0.030, maxAdd: 2.2, tolStart: 5, tolMin: 3, dropSpeed: 16, comboEvery: 3 },
        hard: { name: "Hard", baseSpeed: 2.8, ramp: 0.050, maxAdd: 3.4, tolStart: 4, tolMin: 2, dropSpeed: 20, comboEvery: 3 }
      };

      // Helpers
      function showToast(text, danger=false) {
        toast.textContent = text;
        toast.style.borderColor = danger ? "rgba(251,113,133,0.45)" : "rgba(255,255,255,0.14)";
        toast.style.background = danger ? "rgba(251,113,133,0.16)" : "rgba(255,255,255,0.10)";
        toast.classList.add("show");
        clearTimeout(showToast._t);
        showToast._t = setTimeout(()=> toast.classList.remove("show"), 650);
      }

      // Canvas scaling
      function resizeCanvasToDisplay() {
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        const rect = canvas.getBoundingClientRect();
        const w = Math.floor(rect.width * dpr);
        const h = Math.floor(rect.height * dpr);
        if (canvas.width !== w || canvas.height !== h) {
          canvas.width = w; canvas.height = h;
        }
        ctx.setTransform(1,0,0,1,0,0);
        ctx.scale(dpr, dpr);
        return { w: rect.width, h: rect.height };
      }

      // Audio: SFX + ambient, with ducking
      let audioCtx = null;
      let musicNode = null;
      let masterGain = null;
      let musicGain = null;

      function initAudio() {
        if ((!sfxOn && !musicOn)) return;
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === "suspended") audioCtx.resume();

        if (!masterGain) {
          masterGain = audioCtx.createGain();
          masterGain.gain.value = 1.0;
          masterGain.connect(audioCtx.destination);
        }
        if (!musicGain) {
          musicGain = audioCtx.createGain();
          musicGain.gain.value = 0.0001;
          musicGain.connect(masterGain);
        }
      }

      function duckMusic(ms=220) {
        if (!musicGain || !musicOn) return;
        const t = audioCtx.currentTime;
        const base = Math.max(0.0001, musicVol);
        musicGain.gain.cancelScheduledValues(t);
        musicGain.gain.setValueAtTime(musicGain.gain.value, t);
        musicGain.gain.linearRampToValueAtTime(base * 0.28, t + 0.02);
        musicGain.gain.linearRampToValueAtTime(base, t + (ms/1000));
      }

      function beep({ freq=440, dur=0.06, type="sine", vol=0.06 } = {}) {
        if (!sfxOn || !audioCtx || !masterGain) return;
        const t = audioCtx.currentTime;

        // fatigue prevention detune
        const detune = (Math.random() * 10) - 5;

        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type;
        o.frequency.setValueAtTime(freq + detune, t);

        const v = Math.max(0.0001, vol * sfxVol);
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(v, t + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t + dur);

        o.connect(g);
        g.connect(masterGain);

        o.start(t);
        o.stop(t + dur + 0.02);

        duckMusic(240);
      }

      function sfx(name, streak=0) {
        if (!sfxOn) return;
        const boost = Math.min(220, streak * 22);

        if (name === "place")  beep({ freq: 520 + boost*0.10, dur: 0.045, type: "square",   vol: 0.06 });
        if (name === "slice")  beep({ freq: 330, dur: 0.06, type: "sawtooth", vol: 0.05 });
        if (name === "perfect") {
          beep({ freq: 740 + boost*0.20, dur: 0.05, type: "triangle", vol: 0.09 });
          setTimeout(() => beep({ freq: 990 + boost*0.20, dur: 0.06, type: "triangle", vol: 0.09 }), 55);
        }
        if (name === "gameover") beep({ freq: 180, dur: 0.14, type: "sawtooth", vol: 0.07 });
        if (name === "pause") beep({ freq: 260, dur: 0.07, type: "sine", vol: 0.05 });
        if (name === "resume") beep({ freq: 460, dur: 0.06, type: "sine", vol: 0.05 });
      }

      function startMusic() {
        if (!musicOn) return;
        initAudio();
        if (!audioCtx || !musicGain) return;

        stopMusic();

        // Smooth ambient pad
        const base = audioCtx.createOscillator();
        base.type = "sine";
        base.frequency.value = 110;

        const harm = audioCtx.createOscillator();
        harm.type = "triangle";
        harm.frequency.value = 165;

        base.connect(musicGain);
        harm.connect(musicGain);

        const t = audioCtx.currentTime;
        musicGain.gain.setValueAtTime(0.0001, t);
        musicGain.gain.linearRampToValueAtTime(Math.max(0.0001, musicVol), t + 0.35);

        base.start();
        harm.start();

        musicNode = { base, harm };
      }

      function stopMusic() {
        if (!musicNode) return;
        try { musicNode.base.stop(); } catch {}
        try { musicNode.harm.stop(); } catch {}
        musicNode = null;
      }

      function haptic(pattern=[10]) {
        if (!hapticsOn) return;
        if (navigator.vibrate) navigator.vibrate(pattern);
      }

      // Game state
      let running=false, paused=false, dropInProgress=false, gameOverShown=false;
      let score=0, level=1, streak=0;
      let runType="classic"; // classic|daily|zen
      let dailySeed=0;
      let rafId=null;

      const state = {
        w:0,h:0,groundY:0,
        stack:[], active:null,
        cameraY:0,
        speed:2.2,
        perfectTolerance:4,
        blockH:26,
        baseW:170,
        dropSpeed:16,
        gapY:70
      };

      // Screen shake + perfect flash (respect Reduced Motion)
      let shake=0;
      let flash=0;
      function triggerShake(p=3){ if (!reducedMotion) shake = Math.max(shake, p); }
      function triggerFlash(a=0.12){ if (!reducedMotion) flash = Math.max(flash, a); }

      // Particles (cheap & effective)
      const particles = [];
      function spawnParticles(x,y,count=14) {
        if (reducedMotion) return;
        for (let i=0;i<count;i++){
          particles.push({
            x,y,
            vx:(Math.random()-0.5)*3.4,
            vy:(Math.random()-1.0)*3.8,
            life: 30 + Math.random()*18
          });
        }
        if (particles.length > 160) particles.splice(0, particles.length-160);
      }
      function updateParticles(){
        for (let i=particles.length-1;i>=0;i--){
          const p=particles[i];
          p.vy += 0.08;
          p.x += p.vx;
          p.y += p.vy;
          p.life -= 1;
          if (p.life <= 0) particles.splice(i,1);
        }
      }

      // Daily RNG
      function mulberry32(a){
        return function() {
          let t = a += 0x6D2B79F5;
          t = Math.imul(t ^ (t >>> 15), t | 1);
          t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
          return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        }
      }
      function todaySeed() {
        const d=new Date();
        return (d.getFullYear()*10000 + (d.getMonth()+1)*100 + d.getDate()) >>> 0;
      }

      function runLabel(){
        if (runType==="daily") return "Daily";
        if (runType==="zen") return "Zen";
        return "Classic";
      }
      function applyModeLabel(){
        modeLabel.textContent = `Mode: ${MODES[mode].name} ‚Ä¢ ${runLabel()} ‚Ä¢ Level ${level}`;
      }

      function makeBlock(x,y,w,h,color,moving=false){
        return { x,y,w,h,color,moving,dir:1,vx:0,vy:0 };
      }

      // Debris
      const debris=[];
      function addDebris(p){ debris.push(p); if (debris.length>14) debris.shift(); }
      function updateDebris(){
        for (let i=debris.length-1;i>=0;i--){
          const p=debris[i];
          p.vy += 0.75;
          p.x += p.vx;
          p.y += p.vy;
          if (p.y - state.cameraY > state.h + 260) debris.splice(i,1);
        }
      }

      // Difficulty ramp
      function computeLevel(){ level = Math.max(1, Math.floor(score/10) + 1); }
      function applyDifficulty(){
        const m = MODES[mode];
        const add = Math.min(m.maxAdd, score * m.ramp);
        const levelAdd = Math.min(1.6, (level-1) * 0.12);
        state.speed = m.baseSpeed + add + levelAdd;
        const tighten = Math.floor(score/20) + Math.floor((level-1)/2);
        state.perfectTolerance = Math.max(m.tolMin, m.tolStart - tighten);
        state.dropSpeed = m.dropSpeed;
      }

      function resetGame(){
        score=0; streak=0; level=1;
        dropInProgress=false; gameOverShown=false;
        debris.length=0; particles.length=0;
        scoreEl.textContent="0";
        streakEl.textContent="0";
        applyModeLabel();

        const {w,h} = resizeCanvasToDisplay();
        state.w=w; state.h=h;
        state.groundY=h-90;
        state.stack=[];
        state.cameraY=0;

        let baseW = state.baseW;
        if (runType==="daily") {
          const r = mulberry32(dailySeed)();
          baseW = Math.round(state.baseW + (r*22 - 11));
        }
        const baseX = (w-baseW)/2;
        state.stack.push(makeBlock(baseX, state.groundY - state.blockH, baseW, state.blockH, "rgba(255,255,255,0.14)"));
        spawnActive();
      }

      function spawnActive(){
        computeLevel();
        applyDifficulty();
        applyModeLabel();

        const top = state.stack[state.stack.length-1];
        let nextW = top.w;

        if (runType==="daily") {
          const rng = mulberry32(dailySeed + score + 101);
          nextW = Math.max(60, nextW + ((rng()*10)-5));
        }

        const targetY = top.y - state.blockH;
        const startY = targetY - state.gapY;

        const fromLeft = leftHand ? (score%2===1) : (score%2===0);
        const startX = fromLeft ? -nextW : state.w + nextW;

        state.active = makeBlock(startX, startY, nextW, state.blockH, "#4ade80", true);
        state.active.dir = fromLeft ? 1 : -1;
      }

      // Drawing
      function drawBackground(){
        // Parallax gradient shifts slightly with height
        const climb = Math.min(1, state.cameraY / 900);
        const topCol = `rgb(${Math.round(27 - climb*10)},${Math.round(44 - climb*10)},${Math.round(73 - climb*8)})`;
        const botCol = `rgb(${Math.round(8)},${Math.round(16)},${Math.round(29)})`;

        const g = ctx.createLinearGradient(0,0,0,state.h);
        g.addColorStop(0, topCol);
        g.addColorStop(1, botCol);
        ctx.fillStyle=g;
        ctx.fillRect(0,0,state.w,state.h);

        // stars
        ctx.globalAlpha=0.30;
        ctx.fillStyle="#fff";
        for (let i=0;i<48;i++){
          const x=(i*97)%state.w;
          const y=((i*53)%(state.h*0.55)) + (state.cameraY*0.02)%40;
          ctx.fillRect(x,y,1,1);
        }
        ctx.globalAlpha=1;

        // 2-layer skyline parallax
        ctx.globalAlpha = 0.08;
        ctx.fillStyle = "#fff";
        const baseY = state.groundY;
        for (let i=0;i<16;i++){
          const bw = 16 + (i%5)*10;
          const bh = 70 + (i%7)*22;
          const bx = i*(state.w/16) - ((state.cameraY*0.03)%(state.w/16));
          ctx.fillRect(bx, baseY - bh, bw, bh);
        }
        ctx.globalAlpha = 0.12;
        for (let i=0;i<14;i++){
          const bw = 18 + (i%4)*10;
          const bh = 90 + (i%6)*26;
          const bx = i*(state.w/14) - ((state.cameraY*0.05)%(state.w/14));
          ctx.fillRect(bx, baseY - bh, bw, bh);
        }
        ctx.globalAlpha = 1;

        // ground
        ctx.fillStyle="rgba(0,0,0,0.35)";
        ctx.fillRect(0,state.groundY,state.w,state.h-state.groundY);
        ctx.fillStyle="rgba(255,255,255,0.08)";
        ctx.fillRect(0,state.groundY,state.w,2);
      }

      function drawBlock(b, isActive=false){
        const y = b.y - state.cameraY;

        // shadow
        ctx.globalAlpha=0.20;
        ctx.fillStyle="#000";
        ctx.fillRect(b.x+6, y+8, b.w, b.h);
        ctx.globalAlpha=1;

        // glow on active
        if (isActive && !reducedMotion) {
          ctx.save();
          ctx.shadowColor="rgba(74,222,128,0.55)";
          ctx.shadowBlur=14;
          ctx.fillStyle=b.color;
          ctx.fillRect(b.x,y,b.w,b.h);
          ctx.restore();
        } else {
          ctx.fillStyle=b.color;
          ctx.fillRect(b.x,y,b.w,b.h);
        }

        // high contrast outline
        if (hiContrast) {
          ctx.strokeStyle="rgba(255,255,255,0.38)";
          ctx.lineWidth=2;
          ctx.strokeRect(b.x+1,y+1,b.w-2,b.h-2);
        }

        // highlight
        ctx.globalAlpha=0.16;
        ctx.fillStyle="#fff";
        ctx.fillRect(b.x+6, y+5, Math.max(0,b.w-12), 4);
        ctx.globalAlpha=1;
      }

      function applyShake(){
        if (reducedMotion) return;
        if (shake > 0.1) {
          const dx=(Math.random()-0.5)*shake;
          const dy=(Math.random()-0.5)*shake;
          ctx.translate(dx,dy);
          shake *= 0.85;
        } else shake = 0;
      }

      function drawParticles(){
        if (particles.length === 0) return;
        ctx.globalAlpha = 0.70;
        ctx.fillStyle = "rgba(134,239,172,0.95)";
        for (const p of particles) {
          const r = Math.max(1, Math.min(2.2, p.life/14));
          ctx.beginPath();
          ctx.arc(p.x, p.y - state.cameraY, r, 0, Math.PI*2);
          ctx.fill();
        }
        ctx.globalAlpha = 1;
      }

      function drawFlash(){
        if (flash <= 0) return;
        ctx.globalAlpha = Math.max(0, flash);
        ctx.fillStyle = "#fff";
        ctx.fillRect(0,0,state.w,state.h);
        ctx.globalAlpha = 1;
        flash *= 0.78;
        if (flash < 0.01) flash = 0;
      }

      function drawHUDHint(){
        ctx.globalAlpha=0.65;
        ctx.fillStyle="#fff";
        ctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
        ctx.textAlign="center";
        const hint = paused ? "Paused" : (dropInProgress ? "Dropping..." : "Tap to drop");
        ctx.fillText(`${hint} ‚Ä¢ tol ${state.perfectTolerance}px`, state.w/2, 22);
        ctx.globalAlpha=1;
      }

      function drawScene(){
        drawBackground();

        for (const b of state.stack) drawBlock(b, false);
        for (const p of debris) drawBlock(p, false);
        if (state.active) drawBlock(state.active, true);

        drawParticles();
        drawFlash();
        drawHUDHint();
      }

      // Scoring
      function updateBest(){
        if (score > best) {
          best = score;
          localStorage.setItem(KEYS.best, String(best));
          bestEl.textContent = String(best);
        }
      }

      function award(perfect){
        score += 1;

        if (perfect) {
          score += 1;
          streak += 1;

          if (streak === 1) unlock(ACH.FIRST_PERFECT, "First Perfect");
          if (streak % MODES[mode].comboEvery === 0) {
            score += 1;
            showToast(`üî• Streak ${streak}! +1`);
          } else {
            showToast("Perfect! +2");
          }

          triggerShake(2.6);
          triggerFlash(0.10);
          spawnParticles(state.w*0.5, (state.stack[state.stack.length-1].y - state.cameraY) + 130, 18);

          haptic([10,20,10]);
          sfx("perfect", streak);
        } else {
          streak = 0;
          haptic([8]);
        }

        scoreEl.textContent = String(score);
        streakEl.textContent = String(streak);

        computeLevel();
        updateBest();
        applyModeLabel();

        if (score >= 10) unlock(ACH.TEN_SCORE, "10+ Score");
        if (score >= 50) unlock(ACH.FIFTY_SCORE, "50+ Score");
        if (mode === "hard" && score >= 25) unlock(ACH.HARD_25, "Hard: 25+");
      }

      // Gameplay
      function beginDrop(){
        if (!running || paused) return;
        if (dropInProgress) return;
        const a = state.active;
        if (!a || !a.moving) return;

        initAudio();
        if (musicOn && !musicNode) startMusic();

        a.moving=false;
        dropInProgress=true;
      }

      function resolvePlacement(){
        const a = state.active;
        const prev = state.stack[state.stack.length-1];

        const left = Math.max(a.x, prev.x);
        const right = Math.min(a.x + a.w, prev.x + prev.w);
        const overlap = right - left;

        if (overlap <= 0) {
          if (runType === "zen") {
            streak = 0;
            streakEl.textContent = "0";
            showToast("Zen: Miss (no game over)");
            sfx("gameover", 0);
            haptic([20]);

            state.active = makeBlock(prev.x, prev.y - state.blockH - state.gapY, prev.w, state.blockH, "#4ade80", true);
            state.active.dir = (Math.random()<0.5 ? -1 : 1);

            dropInProgress=false;
            return;
          }

          running=false;
          sfx("gameover", 0);
          haptic([40,60,40]);
          showToast("Miss! Game Over", true);
          triggerShake(6);
          showGameOver();
          return;
        }

        const offset = Math.abs(a.x - prev.x);
        const perfect = offset <= state.perfectTolerance;

        let placedX = left;
        let placedW = overlap;
        if (perfect) {
          placedX = prev.x;
          placedW = prev.w;
        }

        const targetY = prev.y - state.blockH;

        const overhangLeft = placedX - a.x;
        const overhangRight = (a.x + a.w) - (placedX + placedW);

        if (!perfect && (overhangLeft>0 || overhangRight>0)) sfx("slice", streak);

        if (overhangLeft > 0) {
          const fall = makeBlock(a.x, targetY, overhangLeft, a.h, "rgba(74,222,128,0.60)");
          fall.vx=-3; fall.vy=2;
          addDebris(fall);
        }
        if (overhangRight > 0) {
          const fx = placedX + placedW;
          const fall = makeBlock(fx, targetY, overhangRight, a.h, "rgba(74,222,128,0.60)");
          fall.vx=3; fall.vy=2;
          addDebris(fall);
        }

        state.stack.push(makeBlock(placedX, targetY, placedW, state.blockH, "rgba(255,255,255,0.16)"));

        sfx("place", streak);
        award(perfect);

        dropInProgress=false;
        spawnActive();
      }

      // Loop
      function stopLoop(){
        if (rafId) cancelAnimationFrame(rafId);
        rafId=null;
      }

      function step(){
        if (!running || paused) return;

        const {w,h} = resizeCanvasToDisplay();
        state.w=w; state.h=h;
        state.groundY=h-90;

        const a = state.active;

        if (a) {
          if (a.moving) {
            a.x += a.dir * state.speed;
            const pad=26;
            if (a.x < -a.w - pad) a.dir = 1;
            if (a.x > state.w + pad) a.dir = -1;
          } else if (dropInProgress) {
            const prev = state.stack[state.stack.length-1];
            const targetY = prev.y - state.blockH;
            a.y += state.dropSpeed;
            if (a.y >= targetY) {
              a.y = targetY;
              resolvePlacement();
            }
          }
        }

        // camera follow
        const top = state.stack[state.stack.length-1];
        const targetCam = Math.max(0, (top.y - (state.h*0.62)));
        state.cameraY += reducedMotion ? (targetCam - state.cameraY) : (targetCam - state.cameraY) * 0.08;

        updateDebris();
        updateParticles();

        ctx.save();
        applyShake();
        drawScene();
        ctx.restore();

        rafId = requestAnimationFrame(step);
      }

      // Menu
      function showMenu(){
        overlay.style.display="grid";
        overlay.innerHTML = MENU_TEMPLATE;

        const startBtn = overlay.querySelector("#startBtn");
        const dailyBtn = overlay.querySelector("#dailyBtn");
        const zenBtn = overlay.querySelector("#zenBtn");
        const installBtn = overlay.querySelector("#installBtn");
        const easyBtn = overlay.querySelector("#easyBtn");
        const hardBtn = overlay.querySelector("#hardBtn");
        const achPill = overlay.querySelector("#achPill");
        const dailyPill = overlay.querySelector("#dailyPill");

        achPill.textContent = `Achievements: ${achievements.length}`;

        const seed = todaySeed();
        const dailyObj = JSON.parse(localStorage.getItem(KEYS.daily) || "{}");
        if (dailyObj.seed === seed) {
          dailyPill.textContent = `Daily: played ‚Ä¢ score ${dailyObj.score || 0}`;
        } else {
          dailyPill.textContent = (isIOS && !isStandalone) ? "iPhone tip: Share ‚Üí Add to Home Screen" : "Daily: not played";
        }

        easyBtn.style.opacity = (mode==="easy") ? "1" : "0.7";
        hardBtn.style.opacity = (mode==="hard") ? "1" : "0.7";

        easyBtn.addEventListener("click", ()=>{ mode="easy"; localStorage.setItem(KEYS.mode, mode); applyModeLabel(); showToast("Mode: Easy"); });
        hardBtn.addEventListener("click", ()=>{ mode="hard"; localStorage.setItem(KEYS.mode, mode); applyModeLabel(); showToast("Mode: Hard"); });

        startBtn.addEventListener("click", ()=>startRun("classic"));
        dailyBtn.addEventListener("click", ()=>startRun("daily"));
        zenBtn.addEventListener("click", ()=>startRun("zen"));

        if (deferredPrompt) installBtn.style.display="block";
        installBtn.addEventListener("click", async ()=>{
          if (!deferredPrompt) return;
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
          installBtn.style.display="none";
        });
      }

      // Settings overlay (ultimate)
      function showSettings(){
        overlay.style.display="grid";
        overlay.innerHTML = `
          <div class="card">
            <h1>Settings</h1>
            <p>Best options for ultimate gameplay feel.</p>

            <div class="settings">
              <div class="row">
                <label for="modeSel">Mode</label>
                <select id="modeSel">
                  <option value="easy">Easy</option>
                  <option value="hard">Hard</option>
                </select>
              </div>

              <div class="row">
                <label for="sfxChk">Sound (SFX)</label>
                <input id="sfxChk" type="checkbox" />
              </div>

              <div class="row">
                <label for="sfxVol">SFX volume</label>
                <input id="sfxVol" type="range" min="0" max="1" step="0.01" />
              </div>

              <div class="row">
                <label for="musicChk">Ambient music</label>
                <input id="musicChk" type="checkbox" />
              </div>

              <div class="row">
                <label for="musicVol">Music volume</label>
                <input id="musicVol" type="range" min="0" max="1" step="0.01" />
              </div>

              <div class="row">
                <label for="hapChk">Haptics (Android)</label>
                <input id="hapChk" type="checkbox" />
              </div>

              <div class="row">
                <label for="lhChk">Left-handed</label>
                <input id="lhChk" type="checkbox" />
              </div>

              <div class="row">
                <label for="hcChk">High contrast</label>
                <input id="hcChk" type="checkbox" />
              </div>

              <div class="row">
                <label for="rmChk">Reduced motion</label>
                <input id="rmChk" type="checkbox" />
              </div>
            </div>

            <div class="btnrow" style="margin-top:12px;">
              <button class="btn" id="saveBtn">Save</button>
              <button class="btn secondary" id="closeBtn">Close</button>
              <button class="btn secondary" id="resetBtn">Reset Progress</button>
            </div>

            <p style="margin-top:10px;color:rgba(255,255,255,0.60);font-size:12px;">
              Note: iPhone browsers usually don‚Äôt support vibration.
            </p>
          </div>
        `;

        const modeSel = overlay.querySelector("#modeSel");
        const sfxChk = overlay.querySelector("#sfxChk");
        const musicChk = overlay.querySelector("#musicChk");
        const sfxVolEl = overlay.querySelector("#sfxVol");
        const musicVolEl = overlay.querySelector("#musicVol");
        const hapChk = overlay.querySelector("#hapChk");
        const lhChk = overlay.querySelector("#lhChk");
        const hcChk = overlay.querySelector("#hcChk");
        const rmChk = overlay.querySelector("#rmChk");

        modeSel.value = mode;
        sfxChk.checked = sfxOn;
        musicChk.checked = musicOn;
        sfxVolEl.value = String(sfxVol);
        musicVolEl.value = String(musicVol);
        hapChk.checked = hapticsOn;
        lhChk.checked = leftHand;
        hcChk.checked = hiContrast;
        rmChk.checked = reducedMotion;

        overlay.querySelector("#saveBtn").addEventListener("click", ()=>{
          mode = modeSel.value;
          sfxOn = sfxChk.checked;
          musicOn = musicChk.checked;
          sfxVol = Number(sfxVolEl.value);
          musicVol = Number(musicVolEl.value);
          hapticsOn = hapChk.checked;
          leftHand = lhChk.checked;
          hiContrast = hcChk.checked;
          reducedMotion = rmChk.checked;

          localStorage.setItem(KEYS.mode, mode);
          localStorage.setItem(KEYS.sfxOn, sfxOn ? "1":"0");
          localStorage.setItem(KEYS.musicOn, musicOn ? "1":"0");
          localStorage.setItem(KEYS.sfxVol, String(sfxVol));
          localStorage.setItem(KEYS.musicVol, String(musicVol));
          localStorage.setItem(KEYS.haptics, hapticsOn ? "1":"0");
          localStorage.setItem(KEYS.lefthand, leftHand ? "1":"0");
          localStorage.setItem(KEYS.contrast, hiContrast ? "1":"0");
          localStorage.setItem(KEYS.motion, reducedMotion ? "1":"0");

          if (hiContrast) root.classList.add("hc"); else root.classList.remove("hc");

          initAudio();
          if (musicOn) startMusic(); else stopMusic();

          showToast("Saved ‚úÖ");
          overlay.style.display="none";
          if (!running) showMenu();
        });

        overlay.querySelector("#closeBtn").addEventListener("click", ()=>{
          overlay.style.display="none";
          if (!running) showMenu();
        });

        overlay.querySelector("#resetBtn").addEventListener("click", ()=>{
          const ok = confirm("Reset best score + achievements + daily? This cannot be undone.");
          if (!ok) return;

          localStorage.removeItem(KEYS.best);
          localStorage.removeItem(KEYS.achievements);
          localStorage.removeItem(KEYS.daily);

          best = 0;
          achievements = [];
          bestEl.textContent = "0";

          showToast("Reset ‚úÖ");
          overlay.style.display="none";
          if (!running) showMenu();
        });
      }

      function showPauseOverlay(){
        overlay.style.display="grid";
        overlay.innerHTML = `
          <div class="card">
            <h1>Paused</h1>
            <p>${runLabel()} ‚Ä¢ ${MODES[mode].name}<br/>Score: <b>${score}</b> ‚Ä¢ Level: <b>${level}</b> ‚Ä¢ Streak: <b>${streak}</b></p>
            <div class="btnrow">
              <button class="btn" id="resumeBtn">Resume</button>
              <button class="btn secondary" id="restartBtn">Restart</button>
              <button class="btn secondary" id="menuBtn">Main Menu</button>
            </div>
          </div>
        `;
        overlay.querySelector("#resumeBtn").addEventListener("click", ()=>{
          overlay.style.display="none";
          paused=false;
          pauseBtn.textContent="‚è∏";
          sfx("resume", streak);
          step();
        });
        overlay.querySelector("#restartBtn").addEventListener("click", ()=>{
          overlay.style.display="none";
          paused=false;
          resetGame();
          step();
        });
        overlay.querySelector("#menuBtn").addEventListener("click", ()=>{
          running=false;
          paused=false;
          stopLoop();
          if (musicOn) startMusic(); else stopMusic();
          showMenu();
        });
      }

      function showGameOver(){
        if (gameOverShown) return;
        gameOverShown = true;

        if (runType === "daily") {
          const seed = todaySeed();
          localStorage.setItem(KEYS.daily, JSON.stringify({ seed, score, ts: Date.now() }));
          unlock(ACH.DAILY_PLAY, "Daily Played");
        }

        overlay.style.display="grid";
        overlay.innerHTML = `
          <div class="card">
            <h1>Game Over</h1>
            <p>${runLabel()} ‚Ä¢ ${MODES[mode].name}<br/>Score: <b>${score}</b> ‚Ä¢ Best: <b>${best}</b> ‚Ä¢ Level: <b>${level}</b></p>
            <div class="btnrow">
              <button class="btn" id="restartBtn">Restart</button>
              <button class="btn secondary" id="menuBtn">Main Menu</button>
              <button class="btn secondary" id="settingsBtn2">Settings</button>
            </div>
          </div>
        `;
        overlay.querySelector("#restartBtn").addEventListener("click", ()=>{
          overlay.style.display="none";
          paused=false;
          resetGame();
          running=true;
          step();
        });
        overlay.querySelector("#menuBtn").addEventListener("click", ()=>{
          running=false;
          paused=false;
          stopLoop();
          showMenu();
        });
        overlay.querySelector("#settingsBtn2").addEventListener("click", ()=>showSettings());
      }

      function startRun(type){
        initAudio();
        runType = type;
        dailySeed = (type==="daily") ? todaySeed() : 0;

        paused=false;
        running=true;
        dropInProgress=false;
        gameOverShown=false;

        overlay.style.display="none";
        resetGame();

        if (musicOn) startMusic(); else stopMusic();
        step();
      }

      // Controls
      pauseBtn.addEventListener("click", ()=>{
        if (!running) return;
        initAudio();

        if (!paused) {
          paused=true;
          pauseBtn.textContent="‚ñ∂Ô∏è";
          sfx("pause", streak);
          showPauseOverlay();
          stopLoop();
        } else {
          overlay.style.display="none";
          paused=false;
          pauseBtn.textContent="‚è∏";
          sfx("resume", streak);
          step();
        }
      });

      settingsBtn.addEventListener("click", ()=>{
        if (running && !paused) {
          paused=true;
          pauseBtn.textContent="‚ñ∂Ô∏è";
          stopLoop();
        }
        showSettings();
      });

      frame.addEventListener("pointerdown", (e)=>{
        e.preventDefault();
        if (!running || paused) return;
        beginDrop();
      }, { passive:false });

      window.addEventListener("keydown", (e)=>{
        if ((e.code==="Space" || e.code==="Enter") && running && !paused) beginDrop();
        if (e.code==="KeyP") pauseBtn.click();
        if (e.code==="KeyS") settingsBtn.click();
      });

      // Boot
      (function boot(){
        const rect = resizeCanvasToDisplay();
        state.w=rect.w; state.h=rect.h;
        state.groundY=rect.h-90;

        showMenu();

        const params = new URLSearchParams(location.search);
        if (params.get("daily")==="1") startRun("daily");
        else if (params.get("zen")==="1") startRun("zen");

        if (isIOS && !isStandalone) {
          const dailyPill = overlay.querySelector("#dailyPill");
          if (dailyPill && dailyPill.textContent.includes("not played")) {
            dailyPill.textContent = "iPhone tip: Share ‚Üí Add to Home Screen";
          }
        }
      })();

    } catch (err) {
      document.body.innerHTML = `
        <div style="max-width:560px;margin:20px auto;padding:16px;color:#fff;font-family:system-ui;background:#0b1220;border-radius:14px;border:1px solid rgba(255,255,255,0.12);">
          <h2 style="margin:0 0 10px;">City Flip crashed</h2>
          <p style="margin:0 0 12px;opacity:0.85;">Refresh the page. If it keeps happening, clear site data and reload.</p>
          <pre style="white-space:pre-wrap;opacity:0.75;">${String(err)}</pre>
        </div>
      `;
    }
  </script>
</body>
</html>
